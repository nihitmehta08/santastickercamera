<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa In Your House ðŸŽ…ðŸ“¸</title>

<!-- HEIC conversion library -->
<script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>

<style>
    body {
        background: #0b1221;
        color: white;
        font-family: Arial, sans-serif;
        text-align: center;
        padding-bottom: 40px;
    }

    h1 {
        margin-top: 20px;
        font-size: 28px;
    }

    .controls {
        margin-top: 20px;
        background: #111a33;
        padding: 20px;
        border-radius: 12px;
        display: inline-block;
    }

    #preview-container {
        margin-top: 25px;
        position: relative;
        display: inline-block;
        max-width: 95%;
        background: transparent;
    }

    #housePhoto {
        width: 100%;
        display: block;
    }

    #santaSticker {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 200px;
        cursor: grab;
        pointer-events: auto;
    }

    .santa-options img {
        width: 80px;
        padding: 5px;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 10px;
    }

    .santa-options img:hover {
        border-color: #ffd700;
    }

    button {
        background: #ffcc00;
        color: black;
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 15px;
        font-weight: bold;
    }
</style>
</head>
<body>

<h1>Santa In Your House ðŸŽ…ðŸ“¸</h1>

<div class="controls">
    <h3>1. Upload your house photo:</h3>
    <input type="file" id="uploadInput" accept="image/*" />

    <h3>2. Choose your Santa:</h3>
    <div class="santa-options">
        <img src="santa1.png" onclick="selectSanta('santa1.png')">
        <img src="santa2.png" onclick="selectSanta('santa2.png')">
    </div>

    <h3>Santa Size</h3>
    <input type="range" id="sizeSlider" min="50" max="500" value="200" />
</div>

<div id="preview-container">
    <img id="housePhoto" />
    <img id="santaSticker" draggable="false" />
</div>

<button onclick="downloadFinal()">Download Magic Photo âœ¨</button>

<script>
let santa = document.getElementById("santaSticker");
let house = document.getElementById("housePhoto");
let sizeSlider = document.getElementById("sizeSlider");

// -------------------------------
// HEIC SUPPORT + Image Upload
// -------------------------------
document.getElementById("uploadInput").addEventListener("change", async function(e) {
    let file = e.target.files[0];
    if (!file) return;

    // Detect HEIC and convert automatically
    if (file.type === "image/heic" || file.name.endsWith(".heic") || file.name.endsWith(".HEIC")) {
        try {
            const convertedBlob = await heic2any({
                blob: file,
                toType: "image/jpeg",
                quality: 0.9
            });
            file = new File([convertedBlob], "converted.jpg", { type: "image/jpeg" });
        } catch (error) {
            alert("HEIC conversion failed. Try again or use JPG.");
            console.error(error);
            return;
        }
    }

    // Load image into preview
    let reader = new FileReader();
    reader.onload = function(event) {
        house.src = event.target.result;
    };
    reader.readAsDataURL(file);
});

// -------------------------------
// Select Santa
// -------------------------------
function selectSanta(name) {
    santa.src = name;
}

// Resize Santa
sizeSlider.oninput = function () {
    santa.style.width = this.value + "px";
};

// -------------------------------
// Drag Santa
// -------------------------------
let isDown = false;
let offsetX = 0, offsetY = 0;

santa.addEventListener("mousedown", function(e) {
    isDown = true;
    offsetX = e.offsetX;
    offsetY = e.offsetY;
    santa.style.cursor = "grabbing";
});

document.addEventListener("mouseup", function() {
    isDown = false;
    santa.style.cursor = "grab";
});

document.addEventListener("mousemove", function(e) {
    if (!isDown) return;

    let rect = document.getElementById("preview-container").getBoundingClientRect();
    santa.style.left = (e.clientX - rect.left - offsetX) + "px";
    santa.style.top = (e.clientY - rect.top - offsetY) + "px";
});

// -------------------------------
// DOWNLOAD FINAL
// -------------------------------
function downloadFinal() {
    html2canvas(document.getElementById("preview-container"), {
        useCORS: true,
        backgroundColor: null
    }).then(canvas => {
        let link = document.createElement("a");
        link.download = "SantaMagicPhoto.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
}
</script>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</body>
</html>
